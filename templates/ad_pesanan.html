{% include 'ad_header.html' %}
{% include 'ad_navbar.html' %}
{% include 'ad_sidebar.html' %}

<div class="bg-light rounded h-100 p-4">
  <h6 class="mb-4">DATA PESANAN</h6>
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead class="bg-danger text-white">
        <tr>
          <th scope="col">No</th>
          <th scope="col">No. Pesanan</th>
          <th scope="col">Nama Pelanggan</th>
          <th scope="col">Tanggal</th>
          <th scope="col">Status</th>
          <th scope="col" class="text-center">Aksi</th>
        </tr>
      </thead>
      <tbody>
        {% for pesanan in list_pesanan %} 
        <tr id="pesanan-row-{{pesanan._id}}">
          <th scope="row">{{loop.index}}</th>
          <td>{{pesanan.nomor_pesanan}}</td>
          <td>{{pesanan.nama}}</td>
          <td>{{pesanan.tanggal_pesanan}}</td>
          <td><span class="bg-warning text-dark" id="status-{{pesanan._id}}">{{ pesanan.status }}</span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-danger rounded-pill batal-button" data-id="{{pesanan._id}}">Batal</button>
            <button class="btn btn-sm  btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#Detail{{pesanan._id}}">Detail</button>
            <button class="btn btn-sm btn-success rounded-pill status-button" data-id="{{pesanan._id}}">
              {% if pesanan.status == "Proses" %}
                Kirim
              {% else %}
                Lunas
              {% endif %}
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
 {% for pesanan in list_pesanan %}
  
<div class="modal fade" id="Detail{{pesanan._id}}" tabindex="-1" aria-labelledby="exampleModalLabel{{pesanan._id}}" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel{{pesanan._id}}">Detail Pesanan</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-4">
            <table class="table">
              <tr>
                <td class="col-3">Nama</td>
                <td>:</td>
                <td>{{pesanan.nama}}</td>
              </tr>
              <tr>
                <td class="col-3">Email</td>
                <td>:</td>
                <td>{{pesanan.email}}</td>
              </tr>
              <tr>
                <td class="col-3">No. HP</td>
                <td>:</td>
                <td>{{pesanan.telepon}}</td>
              </tr>
              <tr>
                <td class="col-3">Alamat</td>
                <td>:</td>
                <td>{{pesanan.alamat}}</td>
              </tr>
              <tr>
                <td class="col-3">No. Psn</td>
                <td>:</td>
                <td>{{pesanan.nomor_pesanan}}</td>
              </tr>
              <tr>
                <td class="col-3">M. Kirim</td>
                <td>:</td>
                <td>{{pesanan.metode_pengiriman}}</td>
              </tr>
              <tr>
                <td class="col-3">M. Bayar</td>
                <td>:</td>
                <td>{{pesanan.metode_pembayaran}} <br>
                    {{pesanan.no_rek}} <br>
                    {{pesanan.pemilik_rek}}</td>
              </tr>
            </table>
          </div>
          <div class="col-lg-4">
            <h5>Daftar produk</h5>
            <ul>
              {% for item in pesanan.ringkasan_belanja %}
              <li>
                <h6>{{item.nama_produk}}</h6>
                <table>
                  <tr>
                    <td>Harga</td>
                    <td>:</td>
                    <td>Rp. {{item.harga}}</td>
                  </tr>
                  <tr>
                    <td>Jumlah</td>
                    <td>:</td>
                    <td>{{item.jumlah}}</td>
                  </tr>
                </table>
              </li>
              {% endfor %}
            </ul>
            <p>Total Pengiriman : Rp. {{pesanan.total_pengiriman}} <br>
              Total Penjualan : Rp. {{pesanan.total_semuanya}}
            </p>
          </div>
          <div class="col-lg-4">
            <h5>Status Pesanan</h5>
            <div class="alert alert-warning py-2" id="modal-status-{{pesanan._id}}">{{ pesanan.status }}</div>
            <hr>
            <h5>Bukti Transfer</h5>
            <a href="../static/assets/images/client-01.png" data-lightbox="gambar" data-title="Gambar Status Pesanan">
              <img src="../static/assets/images/client-01.png" alt="Gambar Status Pesanan"
                style="max-width: 100%; height: auto; display: block;">
            </a>
          </div>

        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% include 'ad_footer.html' %}

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const statusButtons = document.querySelectorAll(".status-button");
  
    statusButtons.forEach(button => {
      button.addEventListener("click", function() {
        const pesananId = this.getAttribute("data-id");
        const currentStatus = this.textContent.trim();
        let newStatus = "";
  
        if (currentStatus === "Lunas") {
          newStatus = "Proses";
        } else if (currentStatus === "Kirim") {
          newStatus = "Dikirim";
        } else if (currentStatus === "Selesai") {
          newStatus = "Selesai";
        }
  
        fetch(`/update_status/${pesananId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ status: newStatus }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`status-${pesananId}`).textContent = newStatus;
            document.getElementById(`modal-status-${pesananId}`).textContent = newStatus;
  
            if (newStatus === "Proses") {
              document.getElementById(`status-${pesananId}`).classList.remove("bg-warning");
              document.getElementById(`status-${pesananId}`).classList.add("bg-info", "text-white");
              document.getElementById(`modal-status-${pesananId}`).classList.remove("alert-warning");
              document.getElementById(`modal-status-${pesananId}`).classList.add("alert-info");
  
              this.textContent = "Kirim";
              this.classList.remove("btn-success");
              this.classList.add("btn-primary");
  
              const batalButton = document.querySelector(`.batal-button[data-id="${pesananId}"]`);
              if (batalButton) {
                batalButton.style.display = 'inline-block'; 
              }
            } else if (newStatus === "Dikirim") {
              document.getElementById(`status-${pesananId}`).classList.remove("bg-success");
              document.getElementById(`status-${pesananId}`).classList.add("bg-info", "text-white");
              document.getElementById(`modal-status-${pesananId}`).classList.remove("alert-success");
              document.getElementById(`modal-status-${pesananId}`).classList.add("alert-info");
  
              this.textContent = "Selesai";
              this.classList.remove("btn-primary");
              this.classList.add("btn-success");
  
              const batalButton = document.querySelector(`.batal-button[data-id="${pesananId}"]`);
              if (batalButton) {
                batalButton.style.display = 'none'; 
              }
            } else if (newStatus === "Selesai") {
              document.getElementById(`status-${pesananId}`).classList.remove("bg-info");
              document.getElementById(`status-${pesananId}`).classList.add("bg-success", "text-white");
              document.getElementById(`modal-status-${pesananId}`).classList.remove("alert-info");
              document.getElementById(`modal-status-${pesananId}`).classList.add("alert-success");
  
              this.style.display = 'none';
            } else if (newStatus === "Batal") {
              document.getElementById(`status-${pesananId}`).textContent = "Batal";
              document.getElementById(`status-${pesananId}`).classList.remove("bg-warning", "bg-success", "bg-info");
              document.getElementById(`status-${pesananId}`).classList.add("bg-secondary", "text-white");
  
              const modalStatus = document.getElementById(`modal-status-${pesananId}`);
              if (modalStatus) {
                modalStatus.textContent = "Batal";
                modalStatus.classList.remove("alert-warning", "alert-success", "alert-info");
                modalStatus.classList.add("alert-secondary");
              }
  
              const batalButton = document.querySelector(`.batal-button[data-id="${pesananId}"]`);
              if (batalButton) {
                batalButton.style.display = 'none';
              }
  
              const statusButton = document.querySelector(`.status-button[data-id="${pesananId}"]`);
              if (statusButton) {
                statusButton.textContent = "Kirim";
                statusButton.classList.remove("btn-warning", "btn-success");
                statusButton.classList.add("btn-primary");
              }
            }
          }
        });
      });
    });
  
    const batalButtons = document.querySelectorAll(".batal-button");
  
    batalButtons.forEach(button => {
      button.addEventListener("click", function() {
        const pesananId = this.getAttribute("data-id");
  
        fetch(`/update_status/${pesananId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ status: "Batal" }), 
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`status-${pesananId}`).textContent = "Batal";
            document.getElementById(`status-${pesananId}`).classList.remove("bg-warning", "bg-success", "bg-info");
            document.getElementById(`status-${pesananId}`).classList.add("bg-secondary", "text-white");
  
            const modalStatus = document.getElementById(`modal-status-${pesananId}`);
            if (modalStatus) {
              modalStatus.textContent = "Batal";
              modalStatus.classList.remove("alert-warning", "alert-success", "alert-info");
              modalStatus.classList.add("alert-secondary");
            }
            const statusButton = document.querySelector(`.status-button[data-id="${pesananId}"]`);
            if (statusButton) {
              statusButton.style.display = 'none';
            }
  
            this.style.display = 'none';
  
          }
        });
      });
    });
  });
  </script>